<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å‡ºå¸­å‹¾é¸ç³»çµ±ï¼ˆXLSX + æ¬„ä½ç¯©é¸ï¼‰</title>
  <style>
    :root{
      --bg:#f7f7fb; --line:#e5e7eb; --thead:#e2e8f0; --hi:#fff8dc; --hi-hover:#fef9c3;
      --ok:#16a34a; --sticky:#f8fafc; --brand:#2563eb; --ring:rgba(37,99,235,.25);
    }
    *{ box-sizing:border-box }
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif; background:var(--bg); margin:0; color:#111; }
    header { padding:12px 14px; position:sticky; top:0; background:rgba(255,255,255,.9); backdrop-filter:blur(6px); border-bottom:1px solid var(--line); z-index:10; }
    h1 { margin:0 0 6px 0; font-size:1.2rem; }
    .wrap{ max-width:1200px; margin:0 auto; }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; }
    label{ font-size:.9rem; color:#475569 }
    input[type="file"], select, input[type="date"], input[type="text"]{
      padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff; outline:none;
    }
    input[type="file"]:focus, select:focus, input[type="date"]:focus, input[type="text"]:focus{
      box-shadow:0 0 0 3px var(--ring); border-color:var(--brand);
    }
    .btn { border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
    .btn.active { outline:3px solid rgba(22,163,74,.25); }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .stats { display:flex; gap:10px; flex-wrap:wrap; font-size:.95rem; color:#374151; margin-top:8px; }
    .stat { background:#fff; border:1px solid var(--line); border-radius:10px; padding:6px 10px; }
    .hint{ color:#6b7280; font-size:.9rem; margin-top:6px }
    main { padding:12px 14px; }
    table { width:100%; border-collapse: separate; border-spacing:0; margin-top:10px; background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden; }
    thead th { background:var(--thead); position:sticky; top:0; padding:10px; border-bottom:1px solid var(--line); z-index:2; }
    td, th { border-bottom:1px solid var(--line); padding:8px 10px; }
    tbody td { background:#fff; }
    tr:hover { background:var(--hi-hover); cursor:pointer; }
    /* å‡ºå¸­é«˜äº®ï¼ˆæ·ºé»ƒåç™½ï¼‰ */
    tr.present { background:var(--hi); color:#111; font-weight:600; }
    tr.present td { background:var(--hi); }
    /* å‹¾å‹¾æ¬„ä½ï¼ˆstickyï¼‰ */
    .check { width:54px; text-align:center; position:sticky; left:0; z-index:1; background:var(--sticky); border-right:1px solid var(--line); }
    tbody .check { background:#fff; }
    tbody tr.present .check { background:var(--hi); }
    .check .mark { display:inline-block; width:1.6em; height:1.6em; line-height:1.6em; border-radius:999px; border:2px solid var(--line); font-size:18px; font-weight:900; }
    tr.present .check .mark { border-color:var(--ok); color:var(--ok); }
    .search{ flex:1; min-width:220px }
    .filters { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .filters select{ min-width:150px }
    @media (max-width:900px){ table{ font-size:15px } thead th:first-child{ left:0; position:sticky; z-index:3 } }
    @media print{ header,.no-print{ display:none !important } body{ background:#fff } .card{ border:0 } }
  
/* é¡è‰²å¼·åŒ– */
thead th { background:#e0f2fe; } /* æ·ºè—è¡¨é ­ */
tr.present { background:#fff8dc; color:#065f46; font-weight:bold; } /* å‡ºå¸­è¡Œæ·¡é»ƒ+æ·±ç¶ å­— */
.filter-chip { background:#eff6ff; border:1px solid #bfdbfe; color:#1e3a8a; } /* ç¯©é¸æ¨™ç±¤æ·¡è— */
select:focus, input[type="text"]:focus { box-shadow:0 0 0 3px rgba(59,130,246,0.4); border-color:#3b82f6; } /* focus è—æ¡† */
.filters select:hover { background:#f0f9ff; } /* ç¯©é¸é¸å–® hover æ·¡è— */
/* ç¯©é¸åˆ—å½©è‰²æ¨™é¡Œ */
#fClass { border-color:#60a5fa; }
#fSeat { border-color:#c084fc; }
#fId { border-color:#fbbf24; }

/* â€”â€” å·¥å…·åˆ—æŒ‰éˆ•é…è‰² â€”â€” */
.btn{ transition:background .15s ease, color .15s ease, box-shadow .15s ease, border-color .15s ease; border-radius:12px; }
#filterAll{ background:#dbeafe; color:#1e40af; border-color:#bfdbfe; }
#filterAll:hover{ background:#bfdbfe; }
#filterAll.btn.active{ box-shadow:0 0 0 3px rgba(59,130,246,.35); }

#filterPresent{ background:#dcfce7; color:#166534; border-color:#bbf7d0; }
#filterPresent:hover{ background:#bbf7d0; }
#filterPresent.btn.active{ box-shadow:0 0 0 3px rgba(34,197,94,.35); }

#filterAbsent{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
#filterAbsent:hover{ background:#fecaca; }
#filterAbsent.btn.active{ box-shadow:0 0 0 3px rgba(239,68,68,.35); }

#markAllPresent{ background:#16a34a; color:#fff; border-color:#16a34a; }
#markAllPresent:hover{ background:#15803d; border-color:#15803d; }

#markAllAbsent{ background:#4b5563; color:#fff; border-color:#4b5563; }
#markAllAbsent:hover{ background:#374151; border-color:#374151; }

#clearFilter{ background:#f3f4f6; color:#111827; border-color:#e5e7eb; }
#clearFilter:hover{ background:#e5e7eb; }

.btn:focus{ box-shadow:0 0 0 3px rgba(37,99,235,.25); outline:none; }


/* === å¯é…ç½®ä¸»é¡Œè®Šæ•¸ === */
:root{
  --brand:#2563eb;           /* ä¸»è‰² */
  --surface:#ffffff;         /* å¡ç‰‡/è¡¨é¢ */
  --bg:#f7f7fb;              /* èƒŒæ™¯ */
  --text:#111827;            /* æ–‡å­— */
  --line:#e5e7eb;            /* é‚Šæ¡† */
  --thead:#e0f2fe;           /* è¡¨é ­ */
  --present-bg:#fff8dc;      /* å‡ºå¸­åˆ—èƒŒæ™¯ */
  --present-fg:#065f46;      /* å‡ºå¸­åˆ—æ–‡å­— */
  --ring:rgba(37,99,235,.25);
}
body.theme-dark{
  --surface:#0f172a;
  --bg:#0b1220;
  --text:#e5e7eb;
  --line:#334155;
  --thead:#1f2937;
  --present-bg:#1e293b;
  --present-fg:#86efac;
  --ring:rgba(59,130,246,.35);
}
/* å¥—ç”¨è®Šæ•¸åˆ°ä¸»è¦å€å¡Šï¼ˆä¸ç ´å£æ—¢æœ‰å½©è‰²æŒ‰éˆ•ï¼Œä½†å¯è¢«è¦†å¯«ï¼‰ */
body { background:var(--bg); color:var(--text); }
.card{ background:var(--surface); border-color:var(--line); }
thead th { background:var(--thead) !important; }
tr.present { background:var(--present-bg) !important; color:var(--present-fg) !important; }
select:focus, input[type="text"]:focus { box-shadow:0 0 0 3px var(--ring) !important; border-color:var(--brand) !important; }

/* è¨­å®šé¢æ¿æµ®å‹•æŒ‰éˆ• */
#settingsFab{
  position:fixed; right:16px; bottom:18px; z-index:50;
  background:var(--brand); color:#fff; border:none; border-radius:14px;
  padding:10px 12px; font-weight:700; cursor:pointer;
  box-shadow:0 10px 24px rgba(0,0,0,.2);
}
#settingsFab:hover{ filter:brightness(1.05); }
#settingsPanelBackdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px);
  display:none; z-index:60;
}
#settingsPanel{
  position:fixed; right:24px; bottom:80px; width:360px; max-width:92vw;
  background:var(--surface); color:var(--text); border:1px solid var(--line);
  border-radius:16px; padding:14px; box-shadow:0 20px 40px rgba(0,0,0,.25); display:none; z-index:61;
}
#settingsPanel h3{ margin:0 0 8px 0; font-size:1.05rem }
#settingsPanel .row{ display:flex; gap:8px; align-items:center; margin:6px 0; }
#settingsPanel label{ flex:0 0 110px; font-size:.9rem; color:#64748b }
#settingsPanel input[type="text"]{ flex:1; padding:8px 10px; border:1px solid var(--line); background:var(--surface); color:var(--text); border-radius:10px; }
#settingsPanel select, #settingsPanel input[type='color']{ padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:var(--surface); color:var(--text); }
#settingsPanel .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }
#settingsPanel .btn{ border:1px solid var(--line); background:var(--surface); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600 }
#settingsPanel .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }

</style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ğŸ“‹ å‡ºå¸­å‹¾é¸ç³»çµ±ï¼ˆXLSX + æ¬„ä½ç¯©é¸ï¼‰</h1>
      <div class="row">
        <div class="card">
          <div class="row">
            <div>
              <label>åŒ¯å…¥åå–®ï¼š</label><br>
              <input id="file" type="file" accept=".xlsx,.xls,.csv" />
            </div>
            <div>
              <label>å·¥ä½œè¡¨ï¼š</label><br>
              <select id="sheet" disabled></select>
            </div>
            <div>
              <label>é»åæ—¥æœŸï¼š</label><br>
              <input id="attDate" type="date">
            </div>
            <div>
              <label>å ´æ¬¡/ç¯€æ¬¡ï¼ˆå¯é¸ï¼‰ï¼š</label><br>
              <input id="session" type="text" placeholder="ä¾‹ï¼šç¬¬3ç¯€ã€æ—©è‡ªç¿’â€¦" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="btn" id="saveState">å„²å­˜ç‹€æ…‹</div>
            <div class="btn" id="exportAll">åŒ¯å‡º Excelï¼ˆå…¨è¨˜éŒ„ï¼‰</div>
            <div class="btn" id="exportPresent">åŒ¯å‡º å·²å‡ºå¸­</div>
            <div class="btn" id="exportAbsent">åŒ¯å‡º æœªå‡ºå¸­</div>
          </div>
          <div class="hint">â€» è¡¨é ­è‡³å°‘åŒ…å«ã€Œå§“åã€ï¼Œå»ºè­°åŒ…å«ã€Œé …ç›®ã€çµ„åˆ¥ã€å§“åã€ã€‚æ”¯æ´è¡¨é ­è‡ªå‹•è¾¨è­˜ï¼ˆä¾‹å¦‚ï¼šé …ç›®/classï¼›çµ„åˆ¥/no/seatï¼‰ã€‚</div>
        </div>
        <div class="card" style="flex:1">
          <div class="row">
            <input id="search" class="search" type="text" placeholder="æœå°‹å§“åã€çµ„åˆ¥ã€é …ç›®â€¦" />
            <div class="toolbar no-print">
              <button id="filterAll" class="btn active">å…¨éƒ¨</button>
              <button id="filterPresent" class="btn">åªçœ‹å‡ºå¸­</button>
              <button id="filterAbsent" class="btn">åªçœ‹æœªå‡ºå¸­</button>
              <button id="markAllPresent" class="btn">ä¸€éµå…¨å‡ºå¸­</button>
              <button id="markAllAbsent" class="btn">ä¸€éµå…¨æœªå‡ºå¸­</button>
              <button id="clearFilter" class="btn">æ¸…é™¤ç¯©é¸</button>
            </div>
          </div>
          <div class="filters">
            <label>é …ç›®ï¼š<select id="fClass"><option value="">ï¼ˆå…¨éƒ¨ï¼‰</option></select></label>
            <label>çµ„åˆ¥ï¼š<select id="fSeat"><option value="">ï¼ˆå…¨éƒ¨ï¼‰</option></select></label>
            <label>åæ¬¡ï¼š<select id="fId"><option value="">ï¼ˆå…¨éƒ¨ï¼‰</option></select></label>
          </div>
          <div class="stats">
            <div class="stat">ç¸½æ•¸ï¼š<span id="sTotal">0</span></div>
            <div class="stat">å·²å‡ºå¸­ï¼š<span id="sPresent">0</span></div>
            <div class="stat">æœªå‡ºå¸­ï¼š<span id="sAbsent">0</span></div>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:8px">
        <div class="row">
          <span>æ¬„ä½å°æ‡‰ï¼š</span>
          <label style="margin-left:6px">é …ç›®</label><select id="mapClass"></select>
          <label>çµ„åˆ¥</label><select id="mapSeat"></select>
          <label>åæ¬¡</label><select id="mapId"></select>
          <label>å§“å</label><select id="mapName"></select>
          <label>å‚™è¨»</label><select id="mapNote"></select>
          <button class="btn" id="applyMap" title="å¥—ç”¨æ¬„ä½å°æ‡‰">å¥—ç”¨</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <table id="table">
      <thead>
        <tr>
          <th class="check" title="å‡ºå¸­">âœ“</th>
          <th>é …ç›®</th>
          <th>çµ„åˆ¥</th>
          <th>åæ¬¡</th>
          <th>å§“å</th>
          <th>å‚™è¨»</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

<script>
(() => {
  let workbook = null;
  let rawRows = [];
  let roster = []; // {class, seat, id, name, note, present}
  let filterMode = 'all';
  let colFilter = { class:'', seat:'', id:'' };

  const els = {
    file: document.getElementById('file'),
    sheet: document.getElementById('sheet'),
    attDate: document.getElementById('attDate'),
    session: document.getElementById('session'),
    search: document.getElementById('search'),
    tableBody: document.querySelector('#table tbody'),
    sTotal: document.getElementById('sTotal'),
    sPresent: document.getElementById('sPresent'),
    sAbsent: document.getElementById('sAbsent'),
    filterAll: document.getElementById('filterAll'),
    filterPresent: document.getElementById('filterPresent'),
    filterAbsent: document.getElementById('filterAbsent'),
    markAllPresent: document.getElementById('markAllPresent'),
    markAllAbsent: document.getElementById('markAllAbsent'),
    clearFilter: document.getElementById('clearFilter'),
    saveState: document.getElementById('saveState'),
    exportAll: document.getElementById('exportAll'),
    exportPresent: document.getElementById('exportPresent'),
    exportAbsent: document.getElementById('exportAbsent'),
    mapClass: document.getElementById('mapClass'),
    mapSeat: document.getElementById('mapSeat'),
    mapId: document.getElementById('mapId'),
    mapName: document.getElementById('mapName'),
    mapNote: document.getElementById('mapNote'),
    applyMap: document.getElementById('applyMap'),
    fClass: document.getElementById('fClass'),
    fSeat: document.getElementById('fSeat'),
    fId: document.getElementById('fId'),
  };

  // default date = today (local)
  const todayLocalISO = (() => {
    const d = new Date();
    const tzOffset = d.getTimezoneOffset();
    const local = new Date(d.getTime() - tzOffset*60000);
    return local.toISOString().slice(0,10);
  })();
  els.attDate.value = todayLocalISO;

  function hashKey(str){
    let h = 5381;
    for (let i=0;i<str.length;i++) h = ((h<<5)+h) + str.charCodeAt(i);
    return (h>>>0).toString(16);
  }
  function storageKey(){
    const date = els.attDate.value || 'nodate';
    const sess = (els.session.value || '').trim();
    const fn = (els.file.files?.[0]?.name || 'nofile');
    const sheet = els.sheet.value || 'sheet';
    const rosterSig = roster.map(r => (r.class||'')+'#'+(r.seat||'')+'#'+(r.id||'')+'#'+(r.name||'')).join('|');
    const sig = hashKey(fn+'|'+sheet+'|'+rosterSig+'|'+date+'|'+sess);
    return 'attendance_filter:'+sig;
  }

  function normalizeHeader(h){
    const s = String(h || '').trim().toLowerCase();
    if (!s) return '';
    if (['ç­','ç­ç´š','class','ç­åˆ¥','é …ç›®'].includes(s)) return 'class';
    if (['åº§è™Ÿ','è™Ÿ','no','seat','number','#','åºè™Ÿ','çµ„åˆ¥'].includes(s)) return 'seat';
    if (['å­¸è™Ÿ','å­¸ç±è™Ÿ','id','studentid','å­¸è™Ÿid','åæ¬¡'].includes(s)) return 'id';
    if (['å§“å','name','å­¸ç”Ÿå§“å','student','full name'].includes(s)) return 'name';
    if (['å‚™è¨»','å‚™è€ƒ','note','remark','å‚™è¨»æ¬„'].includes(s)) return 'note';
    return s;
  }
  function buildMapping(headers){
    const norm = headers.map(normalizeHeader);
    const find = key => {
      const idx = norm.indexOf(key);
      return idx >= 0 ? headers[idx] : '';
    };
    return {
      class: find('class'),
      seat: find('seat'),
      id: find('id'),
      name: find('name') || headers[0],
      note: find('note')
    };
  }
  function fills(sel, selected, headers){
    sel.innerHTML = ['ï¼ˆä¸ä½¿ç”¨ï¼‰', ...headers].map(h => `<option value="${h}" ${h===selected?'selected':''}>${h}</option>`).join('');
  }
  function populateMapSelectors(headers, mapping){
    fills(els.mapClass, mapping.class || 'ï¼ˆä¸ä½¿ç”¨ï¼‰', headers);
    fills(els.mapSeat,  mapping.seat  || 'ï¼ˆä¸ä½¿ç”¨ï¼‰', headers);
    fills(els.mapId,    mapping.id    || 'ï¼ˆä¸ä½¿ç”¨ï¼‰', headers);
    fills(els.mapName,  mapping.name  || headers[0], headers);
    fills(els.mapNote,  mapping.note  || 'ï¼ˆä¸ä½¿ç”¨ï¼‰', headers);
  }

  function uniqueSorted(arr){
    return Array.from(new Set(arr.map(v => String(v ?? '').trim()).filter(v => v !== ''))).sort((a,b)=>{
      // numeric-aware sort if both numbers
      const na = Number(a), nb = Number(b);
      if (!isNaN(na) && !isNaN(nb)) return na - nb;
      return a.localeCompare(b, 'zh-Hant');
    });
  }
  function rebuildFilters(){
    const classVals = uniqueSorted(roster.map(r => r.class));
    const seatVals  = uniqueSorted(roster.map(r => r.seat));
    const idVals    = uniqueSorted(roster.map(r => r.id));
    const fillSel = (sel, values, cur) => {
      const opts = ['<option value=\"\">ï¼ˆå…¨éƒ¨ï¼‰</option>'].concat(values.map(v => `<option value="${v}" ${v===cur?'selected':''}>${v}</option>`));
      sel.innerHTML = opts.join('');
    };
    fillSel(els.fClass, classVals, colFilter.class);
    fillSel(els.fSeat, seatVals, colFilter.seat);
    fillSel(els.fId, idVals, colFilter.id);
  }

  function applyMapping(){
    if (!rawRows.length) return;
    const map = {
      class: els.mapClass.value === 'ï¼ˆä¸ä½¿ç”¨ï¼‰' ? '' : els.mapClass.value,
      seat:  els.mapSeat.value  === 'ï¼ˆä¸ä½¿ç”¨ï¼‰' ? '' : els.mapSeat.value,
      id:    els.mapId.value    === 'ï¼ˆä¸ä½¿ç”¨ï¼‰' ? '' : els.mapId.value,
      name:  els.mapName.value  === 'ï¼ˆä¸ä½¿ç”¨ï¼‰' ? '' : els.mapName.value,
      note:  els.mapNote.value  === 'ï¼ˆä¸ä½¿ç”¨ï¼‰' ? '' : els.mapNote.value,
    };
    roster = rawRows.map((row, idx) => ({
      idx,
      class: map.class ? (row[map.class] ?? '') : '',
      seat:  map.seat  ? (row[map.seat]  ?? '') : '',
      id:    map.id    ? (row[map.id]    ?? '') : '',
      name:  map.name  ? (row[map.name]  ?? '') : '',
      note:  map.note  ? (row[map.note]  ?? '') : '',
      present: false,
    })).filter(r => String(r.name||'').trim() !== '');
    loadSavedState();
    rebuildFilters();
    renderTable();
  }

  function saveState(){
    const payload = roster.map(r => ({
      key: (r.class||'')+'|'+(r.seat||'')+'|'+(r.id||'')+'|'+(r.name||''),
      present: !!r.present,
      note: r.note || ''
    }));
    localStorage.setItem(storageKey(), JSON.stringify(payload));
    alert('å·²å„²å­˜åˆ°æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚');
  }
  function loadSavedState(){
    try{
      const k = storageKey();
      const saved = JSON.parse(localStorage.getItem(k) || 'null');
      if (saved && Array.isArray(saved)) {
        const byKey = new Map(saved.map(s => [s.key, s]));
        roster.forEach(r => {
          const key = (r.class||'')+'|'+(r.seat||'')+'|'+(r.id||'')+'|'+(r.name||'');
          if (byKey.has(key)) {
            const v = byKey.get(key);
            r.present = !!v.present;
            if (typeof v.note === 'string') r.note = v.note;
          }
        });
      }
    }catch(e){ console.warn('loadSavedState error', e); }
  }

  function visibleByFilter(r){
    if (filterMode==='present' && !r.present) return false;
    if (filterMode==='absent' && r.present) return false;
    if (colFilter.class && String(r.class) !== colFilter.class) return false;
    if (colFilter.seat  && String(r.seat)  !== colFilter.seat)  return false;
    if (colFilter.id    && String(r.id)    !== colFilter.id)    return false;
    return true;
  }
  function updateStats(){
    const total = roster.filter(visibleByFilter).length;
    const present = roster.filter(r => visibleByFilter(r) && !!r.present).length;
    els.sTotal.textContent = total;
    els.sPresent.textContent = present;
    els.sAbsent.textContent = total - present;
  }

  function renderTable(){
    const q = els.search.value.trim().toLowerCase();
    const rows = roster.filter(r => {
      const hay = (r.class+' '+r.seat+' '+r.id+' '+r.name+' '+(r.note||'')).toLowerCase();
      let ok = hay.includes(q);
      ok = ok && visibleByFilter(r);
      return ok;
    });

    els.tableBody.innerHTML = rows.map(r => `
      <tr data-idx="${r.idx}" class="${r.present?'present':''}" role="button" tabindex="0" aria-pressed="${r.present}">
        <td class="check" aria-label="å‡ºå¸­ç‹€æ…‹"><span class="mark">${r.present?'âœ“':''}</span></td>
        <td>${r.class||''}</td>
        <td>${r.seat||''}</td>
        <td>${r.id||''}</td>
        <td>${r.name||''}</td>
        <td contenteditable="true" class="js-note">${r.note||''}</td>
      </tr>
    `).join('');

    // row interactions
    els.tableBody.querySelectorAll('tr').forEach((tr) => {
      tr.addEventListener('click', () => toggleRow(tr));
      tr.addEventListener('keydown', e => { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggleRow(tr); } });
    });
    els.tableBody.querySelectorAll('.js-note').forEach((cell) => {
      cell.addEventListener('input', e => {
        const tr = cell.closest('tr');
        const idx = Number(tr.dataset.idx);
        const row = roster.find(x => x.idx === idx);
        row.note = cell.textContent;
      });
    });

    updateStats();
  }
  function toggleRow(tr){
    const idx = Number(tr.dataset.idx);
    const row = roster.find(x => x.idx === idx);
    row.present = !row.present;
    tr.classList.toggle('present', row.present);
    tr.setAttribute('aria-pressed', row.present);
    const mark = tr.querySelector('.mark');
    if (mark) mark.textContent = row.present ? 'âœ“' : '';
    updateStats();
  }

  function markAll(present){
    roster.forEach(r => r.present = present);
    renderTable();
  }

  function exportExcel(mode){
    if (!roster.length){ alert('å°šæœªæœ‰è³‡æ–™'); return; }
    const date = els.attDate.value || '';
    const sess = (els.session.value || '').trim();
    const title = `å‡ºå¸­_${date}${sess?('_'+sess):''}`;
    let rows = roster.filter(visibleByFilter).map(r => ({
      æ—¥æœŸ: date,
      å ´æ¬¡: sess,
      é …ç›®: r.class || '',
      çµ„åˆ¥: r.seat || '',
      åæ¬¡: r.id || '',
      å§“å: r.name || '',
      å‡ºå¸­: r.present ? 'æ˜¯' : 'å¦',
      å‚™è¨»: r.note || ''
    }));
    if (mode === 'present') rows = rows.filter(r => r['å‡ºå¸­'] === 'æ˜¯');
    if (mode === 'absent')  rows = rows.filter(r => r['å‡ºå¸­'] === 'å¦');

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'å‡ºå¸­');
    XLSX.writeFile(wb, `${title}${mode==='present'?'_å·²å‡ºå¸­':''}${mode==='absent'?'_æœªå‡ºå¸­':''}.xlsx`);
  }

  // File handling
  els.file.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const buf = await file.arrayBuffer();
    workbook = XLSX.read(buf, { type:'array' });
    const sheetNames = workbook.SheetNames || [];
    if (!sheetNames.length){ alert('è®€ä¸åˆ°å·¥ä½œè¡¨'); return; }

    els.sheet.disabled = false;
    els.sheet.innerHTML = sheetNames.map((n,i) => `<option value="${n}" ${i===0?'selected':''}>${n}</option>`).join('');
    loadSheet(sheetNames[0]);
  });
  els.sheet.addEventListener('change', () => loadSheet(els.sheet.value));

  function loadSheet(name){
    const ws = workbook.Sheets[name];
    const rows = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
    rawRows = rows;
    const headers = Object.keys(rows[0] || { å§“å:'', é …ç›®:'', çµ„åˆ¥:'' });
    const mapping = buildMapping(headers);
    populateMapSelectors(headers, mapping);
    applyMapping();
  }

  // Mapping override & UI actions
  els.applyMap.addEventListener('click', () => { colFilter={class:'',seat:'',id:''}; applyMapping(); });
  els.search.addEventListener('input', renderTable);
  els.filterAll.addEventListener('click', () => setFilter('all'));
  els.filterPresent.addEventListener('click', () => setFilter('present'));
  els.filterAbsent.addEventListener('click', () => setFilter('absent'));
  function setFilter(mode){
    filterMode = mode;
    document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
    if (mode==='present') els.filterPresent.classList.add('active');
    else if (mode==='absent') els.filterAbsent.classList.add('active');
    else els.filterAll.classList.add('active');
    renderTable();
  }
  els.clearFilter.addEventListener('click', () => {
    els.search.value=''; setFilter('all'); colFilter={class:'', seat:'', id:''};
    rebuildFilters(); renderTable();
  });
  els.markAllPresent.addEventListener('click', () => markAll(true));
  els.markAllAbsent.addEventListener('click', () => markAll(false));
  els.saveState.addEventListener('click', saveState);
  els.exportAll.addEventListener('click', () => exportExcel('all'));
  els.exportPresent.addEventListener('click', () => exportExcel('present'));
  els.exportAbsent.addEventListener('click', () => exportExcel('absent'));

  // Column filter listeners
  els.fClass.addEventListener('change', () => { colFilter.class = els.fClass.value; renderTable(); });
  els.fSeat.addEventListener('change', () => { colFilter.seat  = els.fSeat.value;  renderTable(); });
  els.fId.addEventListener('change', () => { colFilter.id    = els.fId.value;    renderTable(); });

  // Demo data (å¯ç§»é™¤)
  // roster = [
  //   {idx:0, class:'è·³é ', seat:'A', id:1, name:'ç‹å°æ˜', note:'', present:false},
  //   {idx:1, class:'è·³é ', seat:'A', id:2, name:'é™³å°è¯', note:'', present:true},
  //   {idx:2, class:'è·³é«˜', seat:'B', id:1, name:'å¼µå¤§åŒ', note:'', present:false},
  // ]; rebuildFilters(); renderTable();
})();
</script>

<button id="settingsFab" class="no-print" title="ä¸»é¡Œèˆ‡æ–‡å­—è¨­å®š">âš™ï¸ è¨­å®š</button>
<div id="settingsPanelBackdrop"></div>
<div id="settingsPanel" class="no-print" role="dialog" aria-modal="true">
  <h3>ä¸»é¡Œèˆ‡æ–‡å­—è¨­å®š</h3>
  <div class="row">
    <label>æ¨¡å¼</label>
    <select id="setThemeMode">
      <option value="light">æ·ºè‰²</option>
      <option value="dark">æ·±è‰²</option>
    </select>
  </div>
  <div class="row">
    <label>ä¸»è‰²</label>
    <input id="setBrand" type="color" value="#2563eb"/>
  </div>
  <div class="row"><label>ã€Œå…¨éƒ¨ã€</label><input id="lblAll" type="text" placeholder="å…¨éƒ¨"></div>
  <div class="row"><label>ã€Œåªçœ‹å‡ºå¸­ã€</label><input id="lblPresent" type="text" placeholder="åªçœ‹å‡ºå¸­"></div>
  <div class="row"><label>ã€Œåªçœ‹æœªå‡ºå¸­ã€</label><input id="lblAbsent" type="text" placeholder="åªçœ‹æœªå‡ºå¸­"></div>
  <div class="row"><label>ã€Œä¸€éµå…¨å‡ºå¸­ã€</label><input id="lblMarkAllPresent" type="text" placeholder="ä¸€éµå…¨å‡ºå¸­"></div>
  <div class="row"><label>ã€Œä¸€éµå…¨æœªå‡ºå¸­ã€</label><input id="lblMarkAllAbsent" type="text" placeholder="ä¸€éµå…¨æœªå‡ºå¸­"></div>
  <div class="row"><label>ã€Œæ¸…é™¤ç¯©é¸ã€</label><input id="lblClear" type="text" placeholder="æ¸…é™¤ç¯©é¸"></div>
  <div class="actions">
    <button id="settingsReset" class="btn">å›å¾©é è¨­</button>
    <button id="settingsApply" class="btn primary">å¥—ç”¨ä¸¦å„²å­˜</button>
  </div>
</div>


<style>
.toolbar, .filters, .filter-bar, .right-panel, .sidebar, .control-panel, .sticky, .sticky-header {
  position: static !important;
  top: auto !important;
}
.right-panel, .sidebar, .panel, .container, body, html {
  height: auto !important;
  max-height: none !important;
  overflow: visible !important;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const suspects = document.querySelectorAll(
    '.toolbar, .filters, .filter-bar, .right-panel, .sidebar, .control-panel, .sticky, .sticky-header'
  );
  suspects.forEach(el => {
    const pos = getComputedStyle(el).position;
    if (pos === 'sticky' || pos === 'fixed') {
      el.style.position = 'static';
      el.style.top = 'auto';
      el.style.bottom = 'auto';
    }
  });
  const badScrollContainers = document.querySelectorAll('.scroll-container, .table-wrapper, .main-wrapper');
  badScrollContainers.forEach(el => {
    if (getComputedStyle(el).overflowY !== 'visible') {
      el.style.overflowY = 'visible';
      el.style.maxHeight = 'none';
      el.style.height = 'auto';
    }
  });
});
</script>

<!-- å¼·åˆ¶æ§åˆ¶å€éš¨æ•´é æ²å‹• -->
<style>
/* æ”¾é–‹å…¨é é«˜åº¦/æ²å‹•é™åˆ¶ */
html, body {
  height: auto !important;
  overflow-y: auto !important;
}
</style>
<script>
(function(){
  function unstickAll(){
    const nodes = document.querySelectorAll('*');
    for (const el of nodes){
      const cs = getComputedStyle(el);
      if (cs.position === 'sticky' || cs.position === 'fixed'){
        el.style.position = 'static';
        el.style.top = 'auto';
        el.style.bottom = 'auto';
      }
      // æ¸…é™¤å¯èƒ½é€ æˆå…§æ²çš„å®¹å™¨
      if (cs.overflowY !== 'visible' && (cs.overflowY === 'auto' || cs.overflowY === 'scroll')){
        // åƒ…å°å¤§å‹å®¹å™¨æ”¾é–‹ï¼Œé¿å…ç ´å£ä¸‹æ‹‰é¸å–®
        const h = el.getBoundingClientRect().height;
        if (h > 200){
          el.style.overflowY = 'visible';
          el.style.maxHeight = 'none';
          el.style.height = 'auto';
        }
      }
      // ç§»é™¤ 100vh/å›ºå®šé«˜åº¦é€ æˆçš„å›ºå®šè¦–çª—
      if (/vh$/.test(cs.height) || /vh$/.test(cs.maxHeight)){
        el.style.height = 'auto';
        el.style.maxHeight = 'none';
      }
    }
  }
  // 1) åˆæ¬¡åŸ·è¡Œ
  document.addEventListener('DOMContentLoaded', unstickAll);
  // 2) å»¶é²å†è·‘ä¸€æ¬¡ï¼ˆçµ¦å‹•æ…‹æ¸²æŸ“ï¼‰
  window.addEventListener('load', () => setTimeout(unstickAll, 300));
  // 3) ç›£çœ‹ DOM è®ŠåŒ–ï¼ŒæŒçºŒè§£é™¤ sticky/fixed
  const mo = new MutationObserver(() => unstickAll());
  mo.observe(document.documentElement, {childList:true, subtree:true, attributes:true});
})();
</script>

<!-- æ•´é æ²å‹•ï¼‹æ§åˆ¶å€è·Ÿè‘—æ²èµ°ï¼ˆè§£é™¤ sticky/fixed èˆ‡å…§éƒ¨æ²å‹•å®¹å™¨ï¼‰ -->
<style>
html, body { height: auto !important; overflow-y: auto !important; }
.toolbar, .filters, .filter-bar, .right-panel, .sidebar, .control-panel, .sticky, .sticky-header {
  position: static !important; top: auto !important; bottom: auto !important;
}
.right-panel, .sidebar, .panel, .container {
  height: auto !important; max-height: none !important; overflow: visible !important;
}
/* è‹¥ä»æœ‰è‡ªè¨‚çš„å¯æ²å®¹å™¨ï¼Œå…ˆæ”¾é–‹ï¼ˆè¡¨æ ¼ä½¿ç”¨æ•´é æ²å‹•ï¼‰ */
.scroll-container, .table-wrapper, .main-wrapper {
  overflow: visible !important; max-height: none !important; height: auto !important;
}
</style>
<script>
(function(){
  function unstickAll(){
    const nodes = document.querySelectorAll('*');
    for (const el of nodes){
      const cs = getComputedStyle(el);
      if (cs.position === 'sticky' || cs.position === 'fixed'){
        el.style.position = 'static';
        el.style.top = 'auto';
        el.style.bottom = 'auto';
      }
      if ((cs.overflowY === 'auto' || cs.overflowY === 'scroll') && el.getBoundingClientRect().height > 200){
        el.style.overflowY = 'visible';
        el.style.maxHeight = 'none';
        el.style.height = 'auto';
      }
      if (/vh$/.test(cs.height) || /vh$/.test(cs.maxHeight)){
        el.style.height = 'auto';
        el.style.maxHeight = 'none';
      }
    }
  }
  document.addEventListener('DOMContentLoaded', unstickAll);
  window.addEventListener('load', () => setTimeout(unstickAll, 300));
  const mo = new MutationObserver(() => unstickAll());
  mo.observe(document.documentElement, {childList:true, subtree:true, attributes:true});
})();
</script>


<!-- GAS åŒæ­¥ä¿å›ºç‰ˆï¼ˆè‡ªå‹•å»ºç«‹åŒæ­¥æŒ‰éˆ•ã€2ç§’è¼ªè©¢ã€é»åå¯«å›ï¼‰ -->
<script>
(function(){
  if (window.__GAS_SYNC_PATCHED__) return;
  window.__GAS_SYNC_PATCHED__ = true;

  function ensureToolbar() {
    let tb = document.querySelector('.toolbar');
    if (!tb) {
      tb = document.createElement('div');
      tb.className = 'toolbar';
      tb.style.margin = '8px 0';
      tb.style.display = 'flex';
      tb.style.gap = '8px';
      document.body.prepend(tb);
    }
    return tb;
  }
  const toolbar = ensureToolbar();

  var CONFIG = { API_URL: 'https://script.google.com/macros/s/AKfycbwoLAW6duLEPW9zD-iBTChsXLcrQANPG4jYNSoPht4Ep1j0Njc_QrLN7Lsyb3TEuHeN/exec' };
  async function callAPI(fn, params={}){
    const body = new URLSearchParams(Object.assign({fn}, params));
    const res = await fetch(CONFIG.API_URL, { method:'POST', body });
    return await res.json();
  }

  function ensureButtons(){
    if (!document.getElementById('enableSync')) {
      const b1 = document.createElement('button');
      b1.id = 'enableSync'; b1.textContent = 'å•Ÿç”¨é›²ç«¯åŒæ­¥'; b1.className = 'btn';
      toolbar.prepend(b1);
      b1.addEventListener('click', enableSync);
    }
    if (!document.getElementById('loadFromCloud')) {
      const b2 = document.createElement('button');
      b2.id = 'loadFromCloud'; b2.textContent = 'å¾é›²ç«¯è¼‰å…¥åå–®'; b2.className = 'btn';
      toolbar.prepend(b2);
      b2.addEventListener('click', loadRosterFromCloud);
    }
  }
  ensureButtons();

  const SYNC = { enabled:false, role:'viewer', timer:null, date:'', session:'' };

  async function loadRosterFromCloud(){
    const data = await callAPI('list');
    if (data.error){ alert('é›²ç«¯åå–®éŒ¯èª¤ï¼š'+data.error); return; }
    if (!window.roster) window.roster = [];
    window.roster = (data.rows||[]).map((r,idx)=>({
      idx, class:r.class||'', seat:r.seat||'', id:r.id||'', name:r.name||'', note:r.note||'', present:false
    }));
    if (typeof window.rebuildFilters==='function') window.rebuildFilters();
    if (typeof window.renderTable==='function') window.renderTable();
  }

  async function enableSync(){
    const dateEl = document.getElementById('attDate');
    const sessionEl = document.getElementById('session');
    SYNC.date = dateEl ? dateEl.value : new Date().toISOString().slice(0,10);
    SYNC.session = sessionEl ? sessionEl.value.trim() : 'ç¬¬1ç¯€';
    const me = await callAPI('whoami');
    SYNC.role = me.role || 'viewer';
    SYNC.enabled = true;
    await applyStateFromCloud();
    if (SYNC.timer) clearInterval(SYNC.timer);
    SYNC.timer = setInterval(applyStateFromCloud, 2000);
    alert('å·²å•Ÿç”¨é›²ç«¯åŒæ­¥ï¼ˆä½ çš„æ¬Šé™ï¼š'+SYNC.role+'ï¼‰');
  }

  async function applyStateFromCloud(){
    if (!SYNC.enabled) return;
    const st = await callAPI('getState', { date: SYNC.date, session: SYNC.session });
    const map = (st && st.items) || {};
    if (!Array.isArray(window.roster)) return;
    window.roster.forEach(r=>{
      const key = [r.class||'', r.seat||'', r.id||'', r.name||''].join('|');
      if (key in map) {
        const s = map[key];
        r.present = !!s.present;
        if (typeof s.note === 'string') r.note = s.note;
      }
    });
    if (typeof window.renderTable==='function') window.renderTable();
  }

  function hookActions(){
    if (typeof window.toggleRow === 'function' && !window.__toggleRowHooked) {
      const __orig = window.toggleRow;
      window.toggleRow = async function(tr){
        if (SYNC.enabled && SYNC.role==='viewer') return;
        __orig(tr);
        if (SYNC.enabled) {
          const idx = Number(tr.dataset.idx);
          const r = window.roster.find(x=>x.idx===idx);
          if (r) await callAPI('setState', {
            date: SYNC.date, session: SYNC.session,
            class:r.class||'', seat:r.seat||'', id:r.id||'', name:r.name||'',
            present: r.present ? 1 : 0, note: r.note||''
          });
        }
      };
      window.__toggleRowHooked = true;
    }
    const btnP = document.getElementById('markAllPresent');
    const btnA = document.getElementById('markAllAbsent');
    if (btnP && !btnP.__hooked){
      btnP.addEventListener('click', async ()=>{
        if (SYNC.enabled && SYNC.role==='viewer') return;
        if (typeof window.markAll==='function') window.markAll(true);
        if (SYNC.enabled && Array.isArray(window.roster)) {
          for (const r of window.roster) {
            await callAPI('setState', { date: SYNC.date, session: SYNC.session,
              class:r.class||'', seat:r.seat||'', id:r.id||'', name:r.name||'',
              present:1, note:r.note||'' });
          }
        }
      });
      btnP.__hooked = true;
    }
    if (btnA && !btnA.__hooked){
      btnA.addEventListener('click', async ()=>{
        if (SYNC.enabled && SYNC.role==='viewer') return;
        if (typeof window.markAll==='function') window.markAll(false);
        if (SYNC.enabled && Array.isArray(window.roster)) {
          for (const r of window.roster) {
            await callAPI('setState', { date: SYNC.date, session: SYNC.session,
              class:r.class||'', seat:r.seat||'', id:r.id||'', name:r.name||'',
              present:0, note:r.note||'' });
          }
        }
      });
      btnA.__hooked = true;
    }
  }
  hookActions();
  const mo = new MutationObserver(()=>{ ensureButtons(); hookActions(); });
  mo.observe(document.documentElement, { childList:true, subtree:true });
})();
</script>
</body>

<script>
(function(){
  const KEY = 'attendance_theme_settings_v2';
  const $ = (id)=>document.getElementById(id);

  const els = {
    fab: $('settingsFab'), panel:$('settingsPanel'), backdrop:$('settingsPanelBackdrop'),
    mode:$('setThemeMode'), brand:$('setBrand'),
    lblAll:$('lblAll'), lblPresent:$('lblPresent'), lblAbsent:$('lblAbsent'),
    lblMarkAllPresent:$('lblMarkAllPresent'), lblMarkAllAbsent:$('lblMarkAllAbsent'), lblClear:$('lblClear'),
    apply:$('settingsApply'), reset:$('settingsReset'),
    bAll:$('filterAll'), bPresent:$('filterPresent'), bAbsent:$('filterAbsent'),
    bMarkAllPresent:$('markAllPresent'), bMarkAllAbsent:$('markAllAbsent'), bClear:$('clearFilter')
  };

  function openPanel(){ els.backdrop.style.display='block'; els.panel.style.display='block'; loadToPanel(); }
  function closePanel(){ els.backdrop.style.display='none'; els.panel.style.display='none'; }
  els.fab.addEventListener('click', openPanel);
  els.backdrop.addEventListener('click', closePanel);

  function loadSettings(){
    try{ return JSON.parse(localStorage.getItem(KEY)||'null') || {}; }catch(e){ return {}; }
  }
  function saveSettings(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  function applySettings(s){
    // theme
    const mode = s.mode || 'light';
    document.body.classList.toggle('theme-dark', mode==='dark');
    const brand = s.brand || '#2563eb';
    // apply --brand variable
    document.documentElement.style.setProperty('--brand', brand);

    // labels
    if (s.labels){
      const L = s.labels;
      if (L.all != null) els.bAll.textContent = L.all;
      if (L.present != null) els.bPresent.textContent = L.present;
      if (L.absent != null) els.bAbsent.textContent = L.absent;
      if (L.markAllPresent != null) els.bMarkAllPresent.textContent = L.markAllPresent;
      if (L.markAllAbsent != null) els.bMarkAllAbsent.textContent = L.markAllAbsent;
      if (L.clear != null) els.bClear.textContent = L.clear;
    }
  }

  function loadToPanel(){
    const s = loadSettings();
    els.mode.value = s.mode || 'light';
    els.brand.value = s.brand || '#2563eb';
    const L = s.labels || {};
    els.lblAll.value = L.all || els.bAll.textContent;
    els.lblPresent.value = L.present || els.bPresent.textContent;
    els.lblAbsent.value = L.absent || els.bAbsent.textContent;
    els.lblMarkAllPresent.value = L.markAllPresent || els.bMarkAllPresent.textContent;
    els.lblMarkAllAbsent.value = L.markAllAbsent || els.bMarkAllAbsent.textContent;
    els.lblClear.value = L.clear || els.bClear.textContent;
  }

  els.apply.addEventListener('click', () => {
    const s = {
      mode: els.mode.value,
      brand: els.brand.value,
      labels: {
        all: els.lblAll.value.trim(),
        present: els.lblPresent.value.trim(),
        absent: els.lblAbsent.value.trim(),
        markAllPresent: els.lblMarkAllPresent.value.trim(),
        markAllAbsent: els.lblMarkAllAbsent.value.trim(),
        clear: els.lblClear.value.trim(),
      }
    };
    saveSettings(s);
    applySettings(s);
    closePanel();
  });

  els.reset.addEventListener('click', () => {
    localStorage.removeItem(KEY);
    applySettings({}); // back to defaults
    closePanel();
  });

  // Apply on load
  applySettings(loadSettings());
})();
</script>

</html>
